name: CMake
run-name: ${{ github.actor }} is building the project ðŸš€

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release
  TEST_DIR: "new"

jobs:
  build:
    # The CMake configure and build commands are platform agnostic and should work equally well on Windows or Mac.
    # You can convert this to a matrix build if you need cross-platform coverage.
    # See: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.7" ]

    steps:
      - uses: actions/checkout@v3

      # Install dependency
      - name: Update apt
        run: sudo apt update
      - name: Install Eigen3
        run: sudo apt install -y libeigen3-dev
      - name: Find eigen3 installation location
        run: dpkg -L libeigen3-dev | grep eigen3
      - name: Install Boost
        run: sudo apt-get install libboost-all-dev

      # Update submodules so the missing lsd2 is fixed
      - name: Initialize submodules
        run: git submodule init

      - name: Update submodules
        run: git submodule update --recursive

      - name: Configure CMake
        # Configure CMake in a 'build' subdirectory.
        # `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
        run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

      - name: Build
        # Build your program with the given configuration
        run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

      # working-directory: ${{github.workspace}}/build
      # upload to artifact for other jobs
      - name: Upload iqtree2 build file
        uses: actions/upload-artifact@v3
        with:
          name: iqtree2
          path: build/iqtree2

  test_iqtree2_build:
    # do test for newly build iqtree2
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # download the build file into bin directory of test dir
      - name: Download iqtree2 build file
        uses: actions/download-artifact@v3
        with:
          name: iqtree2
          path: ${{env.TEST_DIR}}/bin

      - name: Run test for iqtree2
        run: |
          cd ${{env.TEST_DIR}}
          chmod +x bin/iqtree2
          python3 test2.py

      - name: Upload the test result for iqtree2
        uses: actions/upload-artifact@v3
        with:
          name: result2
          path: ${{env.TEST_DIR}}/result2


  test_iqtree1:
    # could support multiple platform and multiple version of python
    # test on iqtree 1 and upload the result to artifact
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.7" ]

    steps:
      - uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependency
        run: |
          python -m pip install --upgrade pip
          cd ${{env.TEST_DIR}}
          pip install -r requirements.txt

      # test iqtree1
      - name: testing
        run: |
          cd ${{env.TEST_DIR}}
          python3 test1.py

      - name: upload the test result for iqtree1
        uses: actions/upload-artifact@v3
        with:
          name: result1
          path: ${{env.TEST_DIR}}/result1


  compare_test:
    # get the result1 and result2 from artifact then compare the result
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.7" ]

    needs: [test_iqtree2_build, test_iqtree1]
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download result for iqtree2
        uses: actions/download-artifact@v3
        with:
          name: result2
          path: ${{env.TEST_DIR}}

      - name: Install dependency
        run: |
          python -m pip install --upgrade pip
          cd ${{env.TEST_DIR}}
          pip install -r requirements.txt

      - name: Download result for iqtree1
        uses: actions/download-artifact@v3
        with:
          name: result1
          path: ${{env.TEST_DIR}}

      - name: compare test
        run: |
          cd ${{env.TEST_DIR}}
          python3 test_compare.py

      - name: Display image
        run: |
          cd ${{env.TEST_DIR}}
          echo "![Result](compare result.png)"


